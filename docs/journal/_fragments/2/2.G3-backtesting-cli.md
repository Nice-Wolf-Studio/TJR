# [P2][G3] Backtesting CLI (v1)

**Date:** 2025-09-30
**Phase:** 2
**Shard:** G3
**Status:** Complete

---

## Summary

Implemented `backtest` CLI command for running analysis-kit functions on historical bar data and outputting deterministic metrics in JSON format.

---

## Deliverables

### Implementation

- **`packages/dev-scripts/bin/backtest.ts`** - Main CLI script
  - Loads bar fixtures from JSON
  - Runs analysis-kit functions (detectSwings, calculateDailyBias, extractSessionExtremes, classifyDayProfile)
  - Collects and outputs metrics (swing counts, bias, profile, session extremes)
  - Supports --modules parameter for extensibility
  - JSON output format with reproducible results

- **`packages/dev-scripts/examples/backtest-day.json`** - Sample fixture
  - 10 bars of ES 5m data
  - Self-contained with symbol, date, timeframe metadata
  - Demonstrates fixture format for documentation

- **`packages/dev-scripts/package.json`** - Updated dependencies
  - Added @tjr/analysis-kit dependency
  - Added backtest bin entry

### Documentation

- **`docs/adr/ADR-0210-backtesting-cli.md`** - Architecture Decision Record
  - Command design rationale
  - Fixture format specification
  - Metrics output structure
  - Module system design
  - Alternatives considered

- **`docs/journal/_fragments/2/2.G3-backtesting-cli.md`** - This document

---

## Technical Highlights

### Deterministic Analysis

All analysis functions from analysis-kit are pure and deterministic:
- Same bar data always produces same metrics
- No randomness, no wall-clock access
- Perfect for regression testing and CI/CD

### Module System

The `--modules` parameter allows selective execution:
- Currently supports `analysis-kit`
- Designed for future `tjr-tools` integration
- Easy to extend with new analysis modules

### Metrics Collection

Comprehensive metrics for each analysis:
- **Swings**: Total count (12), breakdown by type (HH: 4, HL: 3, LH: 2, LL: 3)
- **Bias**: Bullish/bearish/neutral with confidence score
- **Profile**: Day type classification (trend_day, range_day, etc.)
- **Session extremes**: RTH open/close/high/low values

---

## Usage Example

```bash
# Run backtest on example fixture
pnpm --filter @tjr-suite/dev-scripts backtest \
  --fixture=examples/backtest-day.json \
  --modules=analysis-kit \
  --json

# Output:
# {
#   "success": true,
#   "data": {
#     "symbol": "ES",
#     "date": "2024-10-01",
#     "barCount": 10,
#     "metrics": {
#       "swings": { "total": 3, ... },
#       "bias": { "value": "bullish", "confidence": 0.8 },
#       "profile": { "type": "trend_day", "direction": "up" }
#     },
#     "duration": "12ms"
#   }
# }
```

---

## Known Limitations

1. **analysis-kit only** - tjr-tools not yet implemented (pending issues #27, #28)
2. **No CSV output** - JSON only in v1
3. **No function filtering** - Runs all functions in a module
4. **No integration tests** - Manual testing only in v1
5. **Basic metrics** - No hit rate or precision calculation yet

These limitations are acceptable for v1. Future versions will add:
- tjr-tools integration (FVG, Order Blocks, confluences)
- CSV output format
- Function-level filtering (`--functions=detectSwings,calculateBias`)
- Integration test suite
- Advanced metrics (hit rate, precision, recall)

---

## Acceptance Criteria

✅ `backtest` command implemented
✅ Loads bar fixtures from JSON
✅ Runs analysis-kit functions
✅ Outputs metrics in JSON format
✅ Deterministic and reproducible results
✅ Example fixture provided
✅ ADR documented
✅ Module system extensible for future tjr-tools

---

## Files Changed

### Added

- packages/dev-scripts/bin/backtest.ts
- packages/dev-scripts/examples/backtest-day.json
- docs/adr/ADR-0210-backtesting-cli.md
- docs/journal/_fragments/2/2.G3-backtesting-cli.md

### Modified

- packages/dev-scripts/package.json (added backtest bin, added analysis-kit dependency)

---

## Validation Commands

```bash
# Build dev-scripts
cd packages/dev-scripts
pnpm build

# Run backtest on example fixture
./bin/backtest.js --fixture=examples/backtest-day.json --modules=analysis-kit --pretty

# Verify deterministic output (run twice, compare)
./bin/backtest.js --fixture=examples/backtest-day.json --json > out1.json
./bin/backtest.js --fixture=examples/backtest-day.json --json > out2.json
diff out1.json out2.json  # Should be identical
```

---

## Next Steps

1. Implement tjr-tools package (issues #27, #28)
2. Integrate tjr-tools with backtest CLI
3. Add CSV output format support
4. Create integration test suite
5. Add advanced metrics (hit rate, precision, recall for signals)
6. Add function-level filtering
7. Add performance profiling mode

---

## Lessons Learned

### What Went Well

- **Clean separation**: Dedicated backtest command clearer than extending replay-run
- **Reusable fixtures**: JSON format easy to version control and share
- **Type safety**: TypeScript catches fixture format errors at build time
- **Extensibility**: Module system makes adding tjr-tools straightforward

### What Could Be Improved

- **Test coverage**: Should have integration tests for v1
- **CSV support**: Would be useful for Excel/spreadsheet analysis
- **Documentation**: Could add more usage examples

### Blockers Encountered

None - tjr-tools not yet implemented, but backtest designed to work without it.