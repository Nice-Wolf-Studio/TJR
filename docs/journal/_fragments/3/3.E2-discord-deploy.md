# Journal Entry: 3.E2 - Discord Deployment & Environment Profiles

## Date: 2024-01-30

## Objective
Implement environment-scoped Discord command deployment with profiles for dev, stage, and prod environments, ensuring idempotent deployments and proper separation of concerns.

## Implementation Summary

### Components Created

1. **Profile System** (`packages/discord-bot-core/src/config/profiles.ts`)
   - Environment-specific configurations
   - Command enablement per environment
   - Guild vs global registration logic
   - Environment variable validation

2. **Enhanced Registrar** (`packages/discord-bot-core/cli/registrar.ts`)
   - Profile-aware command registration
   - Environment selection support
   - Manifest metadata tracking
   - Multi-guild deployment capability

3. **Deployment CLI** (`packages/dev-scripts/bin/commands-deploy.js`)
   - `diff`: Show pending changes
   - `validate`: Check environment configuration
   - `apply`: Deploy changes to Discord
   - `status`: Display current deployment state
   - `rollback`: Restore previous configuration

4. **Documentation** (`docs/ops/discord-envs.md`)
   - Complete environment setup guide
   - Deployment workflow documentation
   - Security best practices
   - CI/CD integration examples

## Key Design Decisions

### Environment Separation
- **Dev**: Guild-specific, all commands, multiple test servers
- **Stage**: Guild-specific, all commands, dedicated staging server
- **Prod**: Global registration, curated command set

### Manifest System
Each environment maintains its own manifest file containing:
- Deployed command definitions
- Environment metadata
- Deployment timestamp
- Registration scope

### Idempotency Approach
- Compare current commands with deployed manifest
- Only apply changes when differences exist
- Support dry-run for change preview
- Force flag for override when needed

## Technical Challenges & Solutions

### Challenge 1: Environment Credential Management
**Problem**: Need separate Discord credentials for each environment without exposing secrets.
**Solution**: Environment-specific variable naming pattern (`DISCORD_<ENV>_TOKEN`) with validation checks.

### Challenge 2: Multi-Guild Deployment
**Problem**: Development needs deployment to multiple test servers simultaneously.
**Solution**: Support comma-separated guild IDs with iterative deployment.

### Challenge 3: Rollback Safety
**Problem**: Need ability to quickly revert problematic deployments.
**Solution**: Automatic manifest backups with timestamped filenames and rollback command.

## Code Snippets

### Profile Configuration
```typescript
export const profiles: Record<Environment, ProfileConfig> = {
  dev: {
    environment: 'dev',
    global: false,
    guildIds: [],  // Populated from env vars
    enabledCommands: ['health', 'daily'],
    manifestPath: './manifests/dev-manifest.json',
  },
  // ...
};
```

### Deployment Validation
```javascript
const validationErrors = validateProfileEnv(profile);
if (validationErrors.length > 0) {
  console.error('Environment validation failed');
  process.exit(1);
}
```

### Idempotent Check
```javascript
if (!hasChanges && !options.force) {
  console.log('No changes detected. Commands are up to date.');
  return;
}
```

## Testing Approach

1. **Unit Tests**: Profile loading and validation
2. **Integration Tests**: Manifest comparison logic
3. **E2E Tests**: Full deployment cycle with dry-run
4. **Manual Validation**: Deploy to test Discord server

## Metrics & Monitoring

- Deployment duration tracking
- Change count per deployment
- Rollback frequency
- Environment validation failures

## Lessons Learned

1. **Manifest versioning is crucial**: Enables reliable rollbacks and audit trails
2. **Dry-run saves time**: Catching issues before they affect Discord
3. **Environment isolation**: Separate apps prevent accidental production changes
4. **Automation value**: CLI tools reduce human error in deployment process

## Next Steps

1. Implement automated tests for deployment scenarios
2. Add deployment notifications (Slack/Discord webhook)
3. Create GitHub Actions workflow for CI/CD
4. Consider manifest encryption for sensitive metadata
5. Add command usage analytics per environment

## Dependencies & Integrations

- Discord.js REST API for command registration
- Commander.js for CLI interface
- Node.js fs for manifest management
- Environment variables for configuration

## Performance Considerations

- Sequential guild deployment (could parallelize)
- Manifest comparison is O(n) where n = command count
- Backup file accumulation needs cleanup strategy

## Security Notes

- Credentials never logged or displayed
- Separate tokens per environment mandatory
- Guild restrictions prevent unauthorized access
- Manifest files contain no sensitive data

## Team Impact

- Developers can safely test in isolation
- DevOps has clear deployment process
- Product can preview features in staging
- Support can verify production state

## References

- Issue: #34 [P3][E2] Discord deployment & env profiles
- ADR: [ADR-0305-discord-deploy.md](../../adr/ADR-0305-discord-deploy.md)
- Docs: [discord-envs.md](../../ops/discord-envs.md)
- Parent: Discord Bot Core implementation

## Conclusion

Successfully implemented a robust, environment-aware Discord command deployment system. The solution provides clear separation between environments, idempotent deployments, and comprehensive tooling for management and rollback. The system is ready for production use with proper credential configuration.