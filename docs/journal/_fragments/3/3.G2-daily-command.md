# [P3][G2] /daily Command - Live-Capable & Formatted Report

**Phase:** 3
**Shard:** G2
**Issue:** #35
**Branch:** phase-3.G2-daily-command
**Status:** Completed
**Date:** 2025-09-30

---

## Summary

Enhanced the `/daily` command with production-ready cache integration and multi-format output capabilities. Implemented a modular formatter supporting text, JSON, table, and markdown formats with deterministic output for testing. Integrated intelligent TTL-based caching with cache-first approach to minimize provider calls while maintaining data freshness. All 111 tests passing with clean TypeScript compilation.

---

## Objectives

- Integrate cache-first approach for improved performance and reduced provider calls
- Create modular formatter with support for multiple output formats
- Implement intelligent TTL strategy (1hr for historical, 1min for recent data)
- Ensure deterministic output for reliable testing
- Maintain graceful handling of missing or partial data
- Document architectural decisions in ADR-0306

---

## Deliverables

### 1. **Formatter Module**

Created `/Users/jeremymiranda/Dev/TJR Project/9/tjr-suite/packages/app/src/formatters/daily-formatter.ts` (357 lines):

- **Multi-format support**: text (default), json, table, markdown
- **Structured data model**: `DailyAnalysisReport` interface with full type safety
- **Deterministic output**: Consistent formatting for test validation
- **Graceful degradation**: Handles missing optional fields elegantly
- **Features**:
  - Text format: Clean, readable plain text output with sections
  - JSON format: Full data structure for programmatic consumption
  - Table format: Box-drawing characters with aligned columns
  - Markdown format: GitHub-flavored markdown with headers and tables

### 2. **Enhanced Daily Command**

Updated `/Users/jeremymiranda/Dev/TJR Project/9/tjr-suite/packages/app/src/commands/daily.command.ts` (376 lines):

- **Cache-first approach**: Check cache before provider calls
- **Intelligent TTL selection**: Automatic TTL based on data recency
- **Cache key strategy**: Deterministic keys with format `daily:SYMBOL:DATE:TYPE:v1`
- **Format option support**: Accept `--format` option (text, json, table, markdown)
- **Metadata tracking**: Optional metadata for cache hits, latency, provider info
- **Performance improvements**:
  - Cache hit: ~1-5ms response time
  - Cache miss: Falls back to provider with caching for future requests
  - Parallel analysis: Bias, profile, and session analysis run concurrently

### 3. **ADR-0306**

Created `/Users/jeremymiranda/Dev/TJR Project/9/tjr-suite/docs/adr/ADR-0306-daily-command.md`:

- **Architecture**: Comprehensive component overview with data flow diagrams
- **Configuration schema**: Full TypeScript interfaces for all config options
- **Error handling strategy**: Enumerated error types with resolution strategies
- **Cache key strategy**: Deterministic key generation with versioning
- **Output format examples**: Concrete examples for all four formats
- **Implementation phases**: 5-phase rollout plan (Phases 2 & 3 completed)
- **Testing strategy**: Unit, integration, and E2E test coverage details
- **Monitoring guidance**: Metrics to track and logging strategies

### 4. **Tests**

Created comprehensive test coverage:

- **Formatter tests** (`packages/app/tests/daily-formatter.test.ts`, 397 lines):
  - Format output validation for all 4 formats
  - Missing field handling scenarios
  - Deterministic output verification
  - Edge case handling (empty sessions, missing metadata)

- **Daily command tests** (`packages/app/tests/daily.test.ts`, 348 lines):
  - Cache hit/miss scenarios
  - TTL selection logic (historical vs recent)
  - Format option handling
  - Error handling and graceful degradation
  - Provider integration with fixtures

**Test Results**: 111/111 passing (100% success rate)

---

## Implementation Notes

### Cache Integration

**Cache-first approach**:
1. Build deterministic cache key from symbol + date + type + version
2. Check cache service for existing result
3. On cache hit: Return cached data with metadata update
4. On cache miss: Fetch from provider, analyze, cache result, return

**TTL Strategy**:
```typescript
private selectCacheTTL(date: Date): number {
  const daysDiff = (now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24);

  if (daysDiff > 2) {
    return 3600000; // 1 hour - Historical data is stable
  }

  return 60000; // 1 minute - Recent data may change
}
```

**Key Format**: `daily:SPY:2025-09-30:analysis:v1`
- Includes version for cache invalidation when analysis logic changes
- Date normalized to ISO format (YYYY-MM-DD) for consistency
- Type field allows caching different analysis types separately

### Formatter Architecture

**Design principles**:
- Single responsibility: Each format method handles one output type
- Deterministic: Same input always produces same output
- Extensible: Easy to add new formats (CSV, HTML planned)
- Type-safe: Full TypeScript interfaces for report structure

**Format implementations**:
- **Text**: Human-readable with labeled sections and proper indentation
- **JSON**: Preserves full data structure with 2-space indentation
- **Table**: Box-drawing characters with aligned columns (Unicode)
- **Markdown**: GitHub-flavored with headers, bullets, and tables

### Technical Challenges

1. **Date/Time Handling**: Market hours vary by timezone
   - Solution: Normalized to US Eastern Time (market standard)
   - Used local date manipulation for session boundaries

2. **Session Analysis**: Filtering bars by time range
   - Solution: Created `filterBarsByTime` helper with minute-based comparison
   - Handles edge cases like pre-market and after-hours

3. **Partial Data**: Some analysis functions may fail
   - Solution: Individual try-catch blocks with fallback values
   - Logs warnings but continues with partial results

4. **Cache Versioning**: Need to invalidate old analysis format
   - Solution: Version suffix in cache key (`v1`)
   - Can increment when analysis logic changes

---

## Test Results

- **Build**: Clean TypeScript compilation (0 errors, 0 warnings)
- **Tests**: 111/111 passing (100% success rate)
- **Formats tested**:
  - Text format with all sections
  - JSON format with full data preservation
  - Table format with box-drawing alignment
  - Markdown format with GitHub-flavored syntax
- **Cache scenarios**:
  - Cache hit (existing data)
  - Cache miss (new request)
  - TTL expiration (historical vs recent)
  - Deterministic key generation
- **Error handling**:
  - Invalid symbol format validation
  - Invalid date format validation
  - Graceful degradation on analysis failures
  - Missing data field handling

---

## Known Limitations

1. **No composite provider**: Currently using fixture provider directly
   - Phase 1 of ADR-0306 not yet implemented
   - No provider fallback chain (primary → secondary → fixture)
   - No timeout handling for provider calls

2. **No provider timeout**: Requests can hang indefinitely
   - Planned for future phase
   - Timeout wrapper not yet implemented

3. **Markdown format simplified**: Basic structure only
   - No advanced formatting features
   - No embedded charts or visualizations
   - Future enhancement planned

4. **Single version**: Cache versioning exists but not actively used
   - No migration strategy for version changes
   - Manual cache clear needed when updating analysis logic

5. **Fixed timeframe**: Only supports 5-minute bars
   - Hardcoded to `Timeframe.M5`
   - Future enhancement for configurable timeframes

---

## Validation

- [x] Clean TypeScript compilation (0 errors)
- [x] ADR-0306 created with comprehensive architecture
- [x] Formatter module with 4 output formats
- [x] Cache integration with cache-first approach
- [x] Intelligent TTL (1hr historical, 1min recent)
- [x] All tests passing (111/111, 100% success)
- [x] Deterministic output for reliable testing
- [x] Graceful missing data handling
- [x] Format option support (--format text|json|table|markdown)
- [x] Metadata tracking (provider, cache hit, latency)
- [x] Session analysis with time-based filtering
- [x] Parallel analysis execution (bias + profile + sessions)

---

## Follow-up Tasks

1. **Composite Provider Implementation** (ADR-0306 Phase 1)
   - Create CompositeProvider class with fallback chain
   - Add timeout wrapper functionality
   - Implement provider chain configuration
   - Unit tests for fallback logic

2. **Provider Timeout Handling**
   - Add configurable timeout per provider
   - Implement timeout wrapper with AbortController
   - Fallback to secondary provider on timeout
   - Test timeout scenarios

3. **Enhanced Markdown Formatting**
   - Add chart embeddings (ASCII or image URLs)
   - Enhanced table formatting with color indicators
   - Summary statistics section
   - Footer with disclaimers

4. **Additional Output Formats**
   - CSV format for spreadsheet import
   - HTML format with styling
   - PDF generation for reports

5. **Cache Management**
   - Cache invalidation strategy for version changes
   - Cache statistics tracking (hit rate, size)
   - Manual cache clear command
   - Cache warming for common symbols

6. **Configuration Enhancements**
   - Configurable timeframe support
   - Custom session definitions
   - Analysis parameter tuning
   - Provider selection override

---

## References

- **Issue**: #35 - /daily command (live-capable) & formatted report
- **ADR**: ADR-0306 - Daily Command Architecture
- **Branch**: phase-3.G2-daily-command
- **Commit**: ea65fe0
- **Files Modified**:
  - `packages/app/src/commands/daily.command.ts` (376 lines)
  - `packages/app/src/formatters/daily-formatter.ts` (357 lines, NEW)
  - `docs/adr/ADR-0306-daily-command.md` (316 lines, NEW)
  - `packages/app/tests/daily-formatter.test.ts` (397 lines, NEW)
  - `packages/app/tests/daily.test.ts` (348 lines, updated)
- **Related ADRs**:
  - ADR-0055: Market Data Core
  - ADR-0059: Analysis Kit
  - ADR-0206: Discord Core