# [51][A2] Contracts DTOs & Error Taxonomy

**Phase:** 51 - TJR Suite Monorepo Foundation
**Shard:** A2
**Date:** 2025-09-29
**Status:** ✅ Complete

## Objective

Create `@tjr/contracts` package containing canonical types, DTOs, and error classes shared across all TJR suite packages.

## What Was Implemented

### Package Structure

```
packages/contracts/
├── src/
│   ├── timeframes.ts    # Timeframe enum + helpers
│   ├── market.ts        # Market data DTOs
│   ├── tjr.ts          # TJR analysis DTOs
│   ├── errors.ts        # Error hierarchy
│   └── index.ts         # Barrel exports
├── tests/
│   ├── timeframes.test.ts
│   ├── errors.test.ts
│   └── tjr.test.ts
├── package.json
├── tsconfig.json
├── vitest.config.ts
└── README.md
```

### Core Exports

**Timeframes** (`src/timeframes.ts`):

- `Timeframe` enum: M1, M5, M10, H1, H4, D1
- Helper functions: `isValidTimeframe`, `timeframeToMinutes`, `getTimeframeLabel`, `compareTimeframes`, `parseTimeframe`, `getAllTimeframes`

**Market Data** (`src/market.ts`):

- `MarketBar`: OHLCV + timestamp
- `GetBarsParams`: Standardized query interface
- `ProviderCapabilities`: Feature flags and limits
- `Session`: Trading session metadata

**TJR Analysis** (`src/tjr.ts`):

- `TJRAnalysisInput`: Analysis request DTO
- `TJRConfluence`: Scoring + factor breakdown
- `TJRExecution`: Entry/stop/target parameters
- `TJRResult`: Complete analysis output
- `hasExecution()`: Type guard utility

**Errors** (`src/errors.ts`):

- `TJRError`: Base error with code, data, timestamp
- `ProviderRateLimitError`: Rate limit exceeded
- `InsufficientBarsError`: Not enough historical data
- `SymbolResolutionError`: Symbol not found
- Type guards: `isTJRError`, `isProviderRateLimitError`, etc.

## Technical Details

### Design Principles

- ✅ **Zero dependencies**: No runtime or external deps
- ✅ **No I/O**: Pure data structures only
- ✅ **Tree-shakeable**: ESM exports
- ✅ **Type-safe**: Strict TypeScript, comprehensive JSDoc
- ✅ **Serializable**: All types JSON-compatible

### TypeScript Configuration

- Target: ES2022
- Module: ES2022
- Strict mode enabled
- Declaration maps for debugging
- Isolated modules for faster builds

### Testing

- Framework: Vitest
- Coverage: All core utilities and type guards
- **Results**: 41 tests passing
  - Timeframes: 13 tests
  - Errors: 18 tests (serialization, type guards)
  - TJR types: 10 tests

### Documentation

- Comprehensive README with usage examples
- JSDoc on all exports with:
  - Parameter descriptions
  - Return types
  - Examples
  - Invariants where applicable
- ADR-0052 documenting architecture decisions

## Validation

```bash
# Build succeeded
pnpm -w --filter @tjr/contracts build
# ✅ TypeScript compilation successful

# Tests passed
pnpm -w --filter @tjr/contracts test
# ✅ 41/41 tests passing
# ✅ 3/3 test files
```

## Acceptance Criteria

- ✅ Package structure created with all required files
- ✅ Timeframes enum (M1, M5, M10, H1, H4, D1) + helpers
- ✅ Market data types (MarketBar, GetBarsParams, ProviderCapabilities, Session)
- ✅ TJR DTOs (TJRAnalysisInput, TJRConfluence, TJRExecution, TJRResult)
- ✅ Error classes with structured fields (code, data, timestamp)
- ✅ All types include comprehensive JSDoc
- ✅ Type-level and runtime tests passing
- ✅ Examples in README showing downstream usage
- ✅ Build succeeds with no errors
- ✅ No I/O operations
- ✅ No external dependencies

## ADR Reference

See [ADR-0052: Contracts Package and Error Taxonomy](../../adr/ADR-0052-contracts-and-errors.md) for:

- Rationale for centralized contracts
- Versioning and semver policy
- Error hierarchy design
- Cross-package usage patterns

## Output Summary

**Lines of Code:**

- Source: ~700 lines (heavily commented)
- Tests: ~400 lines
- Docs: ~200 lines

**Exports:**

- 4 modules (timeframes, market, tjr, errors)
- 7 utility functions
- 11 types/interfaces
- 4 error classes
- 5 type guard functions

**Quality Metrics:**

- TypeScript: Strict mode, no errors
- Tests: 41/41 passing (100%)
- Documentation: 100% JSDoc coverage
- Zero runtime dependencies

## Next Steps

1. Provider packages (Phase 51.A3+) can now import from `@tjr/contracts`
2. Backtesting engine will consume `TJRResult` types
3. Monitor for API changes requiring semver bumps

## Notes

- Package is marked `private: true` (monorepo internal)
- Using `.js` extensions in imports for ESM compatibility
- Error serialization tested for logging/alerting integration
- Timeframe helpers support provider API variations

## Repository

Working directory: `~/dev/51-A2/tjr-suite`
Branch: `phase-51.A2-contracts`

---

**Completed by:** Claude (Coder, QA, Docs, Architect roles)
**Review status:** Ready for PR and code review
