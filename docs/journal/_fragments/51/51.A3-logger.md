# [51][A3] Logger & Error Handler

**Phase:** 51
**Shard:** A3
**Date:** 2025-09-29
**Status:** ✅ Complete

---

## Summary

Created `@tjr/logger` package with structured logging, automatic PII redaction, and global error handling. Package includes comprehensive tests, security documentation, and production-ready implementation.

---

## Deliverables

### Architecture
- ✅ `docs/adr/ADR-0053-logger-and-error-handler.md` - Architectural decision record covering Winston choice, log fields, PII policy, and error handling strategy

### Implementation
- ✅ `packages/logger/` - Complete package implementation
  - `src/types.ts` - TypeScript interfaces and type definitions
  - `src/formats.ts` - Winston formats with PII redaction
  - `src/createLogger.ts` - Logger factory with transport configuration
  - `src/errorHandler.ts` - Global uncaught exception & rejection handlers
  - `src/index.ts` - Public API exports
  - `package.json` - Package metadata with Winston 3.11 dependency
  - `tsconfig.json` - TypeScript configuration extending base config
  - `README.md` - Comprehensive usage documentation

### Quality Assurance
- ✅ `tests/logger.test.ts` - 8 tests covering logger creation, transports, child loggers, filtering
- ✅ `tests/pii-redaction.test.ts` - 9 tests covering all PII redaction patterns
- ✅ `tests/errorHandler.test.ts` - 3 tests covering global handler attachment
- **Test Results:** 20/20 passing

### Security
- ✅ `security/logging-policy.md` - Complete logging security policy covering:
  - Prohibited data types (passwords, keys, PII)
  - Automatic redaction patterns
  - Acceptable data in logs
  - Retention and access control policies
  - GDPR/CCPA/PCI DSS compliance guidelines

---

## Key Features

### Structured Logging
- JSON output for production, pretty-print for development
- ISO 8601 timestamps
- Child loggers with inherited context
- Trading-specific fields: `symbol`, `timeframe`, `request_id`

### PII Redaction (Automatic)
Sensitive fields replaced with `[REDACTED]`:
- `password`, `passwd`, `pwd`
- `api_key`, `apiKey`, `secret`, `token`
- `authorization`, `auth`
- `private_key`, `privateKey`
- `credit_card`, `creditCard`, `ssn`

### Global Error Handling
- Captures `uncaughtException` and `unhandledRejection`
- Logs full stack traces before exit
- Fail-fast philosophy (exits after logging, no recovery)
- Graceful flush with 3-second timeout

---

## Usage Examples

### Basic Logger
```typescript
import { createLogger } from '@tjr/logger';

const logger = createLogger({
  level: 'info',
  json: process.env.NODE_ENV === 'production',
  filePath: './logs/app.log',
});

logger.info('Application started', { version: '1.0.0' });
```

### Child Logger with Context
```typescript
const tradeLogger = logger.child({
  component: 'trading-engine',
  symbol: 'AAPL',
  timeframe: '1h',
});

tradeLogger.info('Signal generated', {
  request_id: 'trade-123',
  signal_type: 'BUY',
  confidence: 0.87,
});
```

### Global Error Handlers
```typescript
import { attachGlobalHandlers } from '@tjr/logger';

attachGlobalHandlers(logger);

// Now all unhandled errors are logged before exit
```

---

## Technical Decisions

### Winston over Pino
- **Chosen:** Winston 3.11
- **Rationale:** More flexible format customization, richer transport ecosystem, mature TypeScript support
- **Trade-off:** Slightly lower raw performance than Pino, but negligible for our use case

### PII Redaction Strategy
- **Approach:** Whitelist-based (redact known-sensitive fields)
- **Implementation:** Custom Winston format filter applied before output
- **Coverage:** 9 test cases covering nested objects, arrays, all sensitive patterns

### Error Handler Behavior
- **Philosophy:** Fail-fast (log and exit, no recovery)
- **Rationale:** Prevents running in corrupted state after unhandled error
- **Safety:** 3-second flush timeout ensures logs are written before exit

---

## Validation Results

### Build
```bash
pnpm -w --filter @tjr/logger build
```
✅ TypeScript compilation successful
✅ Declaration files generated

### Tests
```bash
pnpm -w --filter @tjr/logger test
```
✅ 20 tests, 20 passed, 0 failed
- 8 logger tests (creation, transports, child loggers, filtering)
- 9 PII redaction tests (all patterns, nested, arrays)
- 3 error handler tests (attachment, warnings, logging)

---

## Dependencies Added

### Production
- `winston@^3.11.0` - Logging library
- `logform@^2.7.0` - Winston format utilities

### Development
- `tsx@^4.20.6` - TypeScript test runner
- `@types/node@^20.11.0` - Node.js type definitions
- `typescript@^5.3.3` - TypeScript compiler

---

## Files Changed

### Created (13 files)
- `docs/adr/ADR-0053-logger-and-error-handler.md`
- `packages/logger/package.json`
- `packages/logger/tsconfig.json`
- `packages/logger/README.md`
- `packages/logger/src/index.ts`
- `packages/logger/src/types.ts`
- `packages/logger/src/formats.ts`
- `packages/logger/src/createLogger.ts`
- `packages/logger/src/errorHandler.ts`
- `packages/logger/tests/logger.test.ts`
- `packages/logger/tests/pii-redaction.test.ts`
- `packages/logger/tests/errorHandler.test.ts`
- `security/logging-policy.md`

### Modified
- `pnpm-lock.yaml` (dependency additions)

---

## Known Limitations

1. **Test Coverage:** Error handler actual behavior (process exit) not tested in unit tests
   - **Reason:** Would terminate test runner
   - **Mitigation:** Behavior tested manually, integration tests recommended for future

2. **Log Rotation:** Not implemented in this shard
   - **Reason:** Out of scope for basic logger
   - **Future Work:** Add `winston-daily-rotate-file` transport in future shard

3. **PII Redaction:** Pattern-based, not semantic
   - **Coverage:** Redacts known-sensitive field names
   - **Limitation:** Won't catch sensitive data in generic fields like `data` or `payload`
   - **Mitigation:** Developer guidelines in security policy, code review checklist

---

## Next Steps

1. **Adoption:** Migrate existing packages to use `@tjr/logger` (future shards)
2. **Monitoring:** Integrate with observability platform (future)
3. **Log Rotation:** Add file rotation for production (future)
4. **Metrics:** Add logger performance metrics (future)

---

## References

- ADR-0053: Logger and Error Handler
- Security Policy: `security/logging-policy.md`
- Package README: `packages/logger/README.md`
- [Winston Documentation](https://github.com/winstonjs/winston)
- [OWASP Logging Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Logging_Cheat_Sheet.html)

---

## Sign-off

**PM:** ✅ Requirements met
**Architect:** ✅ ADR approved
**Coder:** ✅ Implementation complete
**QA:** ✅ All tests passing (20/20)
**Security:** ✅ Policy documented, PII redaction validated
**Docs:** ✅ README and journal complete

**Ready for PR:** ✅