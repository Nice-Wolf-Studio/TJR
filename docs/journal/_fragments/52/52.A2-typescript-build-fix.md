# 52.A2 TypeScript Build Fix

**Date**: 2025-10-01
**Type**: Bug Fix
**Scope**: Build Infrastructure

## Problem

After PR #69 merge, TypeScript build errors occurred in the monorepo:

1. **provider-polygon rootDir error**: TypeScript compiler attempted to compile files from `market-data-core/src` when building `provider-polygon`, violating rootDir constraint
2. **Timeframe type incompatibility**: Type mismatch between `market-data-core` Timeframe (string union) and `contracts` Timeframe (enum)

### Root Cause

The issue stemmed from incorrect TypeScript path mapping in `tsconfig.base.json`:
- Path `@tjr-suite/*` mapped to `packages/*/src` (source files)
- This caused TypeScript to include source files from dependencies during compilation
- TypeScript expected all compiled files to be under the package's `rootDir`

Additional issue: Two incompatible Timeframe type definitions existed:
- `market-data-core`: `"1m" | "5m" | "10m" | ... | "1D"` (string union)
- `contracts`: `enum Timeframe { M1='1', M5='5', ... }` (enum with different values)

## Solution

Applied smallest reversible changes following Wolf Ethos:

### 1. Fixed Path Mapping (tsconfig.base.json)
```diff
- "@tjr-suite/*": ["packages/*/src"],
+ "@tjr-suite/*": ["packages/*/dist"],
```

This ensures packages reference compiled output, not source files.

### 2. Added rootDir to provider-polygon
```json
{
  "compilerOptions": {
    "rootDir": "./src",
    ...
  }
}
```

### 3. Added Project References
```json
{
  "references": [
    { "path": "../market-data-core" },
    { "path": "../contracts" },
    { "path": "../logger" }
  ]
}
```

### 4. Resolved Timeframe Type Conflict
- Updated provider-polygon to use `contracts` Timeframe enum
- Created conversion function `toCoreTimeframe()` to map enum values to string format for `market-data-core` APIs
- Updated all timeframe arrays and mappings to use enum values

## Verification

```bash
pnpm -r build
```

All packages build successfully except `provider-composite` which has pre-existing unrelated issues with cache API usage.

## Files Changed

- `/tsconfig.base.json` - Fixed path mapping
- `/packages/provider-polygon/tsconfig.json` - Added rootDir and references
- `/packages/provider-polygon/src/aggregate.ts` - Timeframe enum conversion
- `/packages/provider-polygon/src/index.ts` - Import Timeframe from contracts
- `/packages/provider-polygon/src/types.ts` - Import Timeframe from contracts

## Notes

The fix maintains backward compatibility while properly isolating package compilation boundaries. The Timeframe conversion function allows provider-polygon to work with both the contracts enum (for public API) and market-data-core utilities (for internal aggregation).
